<!-- === JG MAP v2.8 - System zg≈Çosze≈Ñ miejsc === -->
<div id="jg-map-wrap" class="jg-wrap">
  <div id="jg-map-filters" class="jg-filters">
    <label><input type="checkbox" data-type="zgloszenie" checked> Zg≈Çoszenia</label>
    <label><input type="checkbox" data-type="ciekawostka" checked> Ciekawostki</label>
    <label><input type="checkbox" data-type="miejsce" checked> Miejsca</label>
    <label style="margin-left:auto"><input type="checkbox" data-promo> Tylko promocje</label>
    <div class="jg-search">
      <input type="text" id="jg-search-input" placeholder="üîç Szukaj miejsca..." />
    </div>
  </div>

  <div id="jg-map" class="jg-map" style="opacity: 0; transition: opacity 0.3s;">
    <div id="jg-map-loading" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1000;background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.15)">
      ≈Åadowanie mapy...
    </div>
    <div id="jg-map-error" style="display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1000;background:#fee;padding:20px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.15);color:#c00;max-width:400px">
      <strong>B≈ÇƒÖd ≈Çadowania mapy</strong><br>
      <span id="error-msg"></span>
    </div>
  </div>

  <div id="jg-map-modal-add" class="jg-modal-bg"><div class="jg-modal"></div></div>
  <div id="jg-map-modal-view" class="jg-modal-bg"><div class="jg-modal"></div></div>
  <div id="jg-map-modal-report" class="jg-modal-bg"><div class="jg-modal"></div></div>
  <div id="jg-map-modal-reports-list" class="jg-modal-bg"><div class="jg-modal"></div></div>
  <div id="jg-map-modal-edit" class="jg-modal-bg"><div class="jg-modal"></div></div>
  <div id="jg-map-modal-author" class="jg-modal-bg"><div class="jg-modal"></div></div>
  <div id="jg-map-modal-status" class="jg-modal-bg"><div class="jg-modal"></div></div>
  <div id="jg-map-lightbox" class="jg-modal-bg"><div class="jg-lightbox"></div></div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
  .jg-wrap{position:relative}
  .jg-map{position:relative;width:100%;height:560px;border-radius:12px;overflow:hidden;background:#e5e7eb}
  .jg-filters{display:flex;gap:16px;align-items:center;padding:16px 0;font:15px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial;flex-wrap:wrap;background:#f9fafb;border-radius:12px;padding:12px 16px;margin-bottom:8px}
  .jg-filters label{display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px 12px;border-radius:8px;transition:background 0.2s;user-select:none}
  .jg-filters label:hover{background:#f3f4f6}
  .jg-filters input[type="checkbox"]{width:20px;height:20px;cursor:pointer;margin:0}

  .jg-search{flex:1;min-width:200px;max-width:300px}
  .jg-search input{width:100%;padding:10px 16px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;transition:all 0.2s;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .jg-search input:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,0.1)}

  .jg-modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);align-items:center;justify-content:center;z-index:9999;padding:18px}
  .jg-modal{background:#fff;color:#111;width:min(900px,96vw);max-height:85vh;border-radius:12px;padding:14px;overflow:auto}
  .jg-modal header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:-14px -14px 16px -14px;padding:16px 14px;position:sticky;top:-14px;background:#fff;z-index:2;border-bottom:2px solid #eee;border-radius:12px 12px 0 0}
  .jg-modal header h3{margin:0;font-size:22px;font-weight:700;color:#111}
  .jg-modal header .jg-close{font-size:24px;line-height:1;background:transparent;border:none;cursor:pointer;padding:4px 8px;color:#666}
  .jg-modal--miejsce header{background:#d1fae5;border-bottom-color:#86efac}
  .jg-modal--ciekawostka header{background:#dbeafe;border-bottom-color:#93c5fd}
  .jg-modal--zgloszenie header{background:#e5e7eb;border-bottom-color:#d1d5db}
  .jg-modal--promo header{background:linear-gradient(90deg,#fff7e6,#fef3c7);border-bottom-color:#f7d899}
  .jg-btn{background:#111;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;font-size:14px}
  .jg-btn:hover{background:#333}
  .jg-btn.jg-btn--ghost{background:transparent;color:#111;border:1px solid #ddd}
  .jg-btn.jg-btn--ghost:hover{background:#f5f5f5}
  .jg-btn.jg-btn--danger{background:#dc2626;color:#fff}
  .jg-btn.jg-btn--danger:hover{background:#b91c1c}
  .jg-grid{display:grid;gap:10px}
  .jg-grid.cols-2{grid-template-columns:1fr 1fr}
  .jg-grid.cols-2>.cols-2{grid-column:1/-1}
  .jg-badge{display:inline-block;background:#f0f2f5;color:#111;border-radius:999px;padding:4px 8px;font-size:12px;margin-right:6px}
  .jg-promo-tag{display:inline-block;background:linear-gradient(90deg,#f59e0b,#fbbf24);color:#111;padding:4px 8px;border-radius:999px;font-weight:700;margin-right:6px}
  .jg-vote{display:flex;align-items:center;gap:8px;margin-top:10px}
  .jg-vote button{padding:6px 12px;border:1px solid #ddd;background:#fff;cursor:pointer;border-radius:6px;font-size:16px}
  .jg-vote button:hover{background:#f5f5f5}
  .jg-vote button.active{outline:2px solid #111;border-color:#111}

  .jg-gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
  .jg-gallery img{width:100%;height:140px;object-fit:cover;border-radius:10px;cursor:pointer;transition:transform 0.2s}
  .jg-gallery img:hover{transform:scale(1.05)}
  .jg-lightbox{background:#000;width:min(92vw,1200px);max-height:90vh;border-radius:12px;position:relative;padding:0;overflow:hidden}
  .jg-lightbox img{display:block;max-width:100%;max-height:90vh;margin:0 auto}
  .jg-lightbox .jg-lb-close{position:absolute;top:8px;right:10px;background:rgba(255,255,255,.85);border:none;border-radius:8px;padding:6px 10px;cursor:pointer;font-weight:600}

  .jg-pin{display:flex;align-items:center;justify-content:center;font-weight:700;border-radius:50%;box-shadow:0 2px 10px rgba(0,0,0,.35);color:#fff;background:#111;font-size:14px}
  .jg-pin--ciekawostka{background:#2563eb}
  .jg-pin--miejsce{background:#16a34a}
  .jg-pin--promo{background:linear-gradient(135deg,#f59e0b,#fbbf24,#f59e0b);color:#111;font-size:16px;font-weight:800;box-shadow:0 0 0 0 rgba(245,158,11,0.7), 0 4px 16px rgba(245,158,11,0.5)}
  .jg-pin.jg-pin--pending{background:#dc2626 !important;opacity:0.7 !important}
  .jg-pin.jg-pin--edit{background:#9333ea !important;opacity:0.7 !important}
  .jg-pin.jg-pin--reported::after{content:attr(data-reports);position:absolute;top:-8px;right:-8px;background:#dc2626;color:#fff;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;border:2px solid #fff;z-index:10}

  .leaflet-marker-icon.jg-pin--promo{z-index:1000 !important}

  .jg-marker-label{position:absolute;left:100%;top:50%;transform:translateY(-50%);margin-left:8px;background:rgba(255,255,255,0.95);color:#111;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:600;white-space:nowrap;box-shadow:0 2px 8px rgba(0,0,0,0.2);border:1px solid rgba(0,0,0,0.1);pointer-events:none;z-index:1000;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .jg-marker-label--promo{background:linear-gradient(135deg,#fff7e6,#fef3c7);border:2px solid #f59e0b;padding:6px 12px;font-size:13px;font-weight:700;box-shadow:0 3px 12px rgba(245,158,11,0.4)}
  .jg-marker-label--pending{background:rgba(254,226,226,0.95) !important;color:#991b1b !important;border:1px solid #dc2626 !important;opacity:0.9 !important}
  .jg-marker-label--edit{background:rgba(243,232,255,0.95) !important;color:#6b21a8 !important;border:1px solid #9333ea !important;opacity:0.9 !important}

  .jg-admin-note{background:#fef3c7;border:2px solid #f59e0b;border-radius:8px;padding:12px;margin:16px 0}
  .jg-admin-note-title{font-weight:700;color:#92400e;margin-bottom:8px;font-size:14px}
  .jg-admin-note-content{color:#78350f;line-height:1.5}

  .jg-admin-panel{background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px;margin-top:16px}
  .jg-admin-panel-title{font-weight:700;margin-bottom:8px;color:#0f172a}
  .jg-admin-controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}

  .jg-reports-warning{background:#fee;border:2px solid #dc2626;border-radius:8px;padding:12px;margin:16px 0}
  .jg-reports-warning-title{font-weight:700;color:#dc2626;margin-bottom:8px;font-size:16px}
  .jg-report-item{background:#fff;border:1px solid #ddd;border-radius:6px;padding:10px;margin-top:8px}
  .jg-report-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .jg-report-item-user{font-weight:600;color:#111}
  .jg-report-item-date{font-size:12px;color:#666}
  .jg-report-item-reason{color:#444;font-size:14px;line-height:1.5}

  .jg-date-info{font-size:13px;color:#6b7280;margin-bottom:12px}
  .jg-status-badge{display:inline-block;padding:6px 12px;border-radius:6px;font-size:13px;font-weight:600;margin-bottom:12px}
  .jg-status-badge--added{background:#e5e7eb;color:#374151}
  .jg-status-badge--reported{background:#dbeafe;color:#1e40af}
  .jg-status-badge--resolved{background:#d1fae5;color:#065f46}

  .leaflet-container{background:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .leaflet-container a{color:#2563eb}
</style>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
(function(){
  var loadingEl = document.getElementById('jg-map-loading');
  var errorEl = document.getElementById('jg-map-error');
  var errorMsg = document.getElementById('error-msg');

  function showError(msg){
    console.error('[JG MAP]', msg);
    if(loadingEl) loadingEl.style.display = 'none';
    if(errorEl) errorEl.style.display = 'block';
    if(errorMsg) errorMsg.textContent = msg;
  }

  function hideLoading(){
    if(loadingEl) loadingEl.style.display = 'none';
  }

  function wait(cb, maxAttempts){
    var attempts = 0;
    var interval = setInterval(function(){
      attempts++;

      if(window.L && L.map && L.markerClusterGroup){
        clearInterval(interval);
        hideLoading();
        console.log('[JG MAP] Wszystkie biblioteki za≈Çadowane');
        cb();
        return;
      }

      if(attempts > maxAttempts){
        clearInterval(interval);
        var missing = [];
        if(!window.L) missing.push('Leaflet');
        if(window.L && !L.map) missing.push('L.map');
        if(window.L && !L.markerClusterGroup) missing.push('L.markerClusterGroup');
        showError('Nie uda≈Ço siƒô za≈Çadowaƒá: ' + missing.join(', '));
      }
    }, 100);
  }

  wait(init, 100);

  function init(){
    try {
      var CFG = window.JG_MAP_CFG || {};
      if(!CFG.ajax || !CFG.nonce){
        showError('Brak konfiguracji JG_MAP_CFG');
        return;
      }

      var elMap = document.getElementById('jg-map');
      var elFilters = document.getElementById('jg-map-filters');
      var modalAdd = document.getElementById('jg-map-modal-add');
      var modalView = document.getElementById('jg-map-modal-view');
      var modalReport = document.getElementById('jg-map-modal-report');
      var modalReportsList = document.getElementById('jg-map-modal-reports-list');
      var modalEdit = document.getElementById('jg-map-modal-edit');
      var modalAuthor = document.getElementById('jg-map-modal-author');
      var modalStatus = document.getElementById('jg-map-modal-status');
      var lightbox = document.getElementById('jg-map-lightbox');

      if(!elMap){
        showError('Nie znaleziono #jg-map');
        return;
      }

      if((elMap.offsetHeight||0) < 50) elMap.style.minHeight = '520px';

      function qs(s,p){
        return (p||document).querySelector(s);
      }

      function esc(s){
        s = String(s || '');
        return s.replace(/[&<>"']/g, function(m){
          return {"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m];
        });
      }

      function open(bg, html, opts){
        if(!bg) return;
        var c = qs('.jg-modal, .jg-lightbox', bg);
        if(!c) return;
        if(opts && opts.addClass){
          var classes = opts.addClass.trim().split(/\s+/);
          classes.forEach(function(cls){
            if(cls) c.classList.add(cls);
          });
        }
        c.innerHTML = html;
        bg.style.display = 'flex';
      }

      function close(bg){
        if(!bg) return;
        var c = qs('.jg-modal, .jg-lightbox', bg);
        if(c){
          c.className = c.className.replace(/\bjg-modal--\w+/g, '');
          if(!c.classList.contains('jg-modal') && !c.classList.contains('jg-lightbox')){
            c.className = 'jg-modal';
          }
        }
        bg.style.display = 'none';
      }

      [modalAdd, modalView, modalReport, modalReportsList, modalEdit, modalAuthor, modalStatus, lightbox].forEach(function(bg){
        if(!bg) return;
        bg.addEventListener('click', function(e){
          if(e.target === bg) close(bg);
        });
      });

      document.addEventListener('keydown', function(e){
        if(e.key === 'Escape'){
          [modalAdd, modalView, modalReport, modalReportsList, modalEdit, modalAuthor, modalStatus, lightbox].forEach(close);
        }
      });

      var lat = (CFG.defaults && typeof CFG.defaults.lat === 'number') ? CFG.defaults.lat : 50.904;
      var lng = (CFG.defaults && typeof CFG.defaults.lng === 'number') ? CFG.defaults.lng : 15.734;
      var zoom = (CFG.defaults && typeof CFG.defaults.zoom === 'number') ? CFG.defaults.zoom : 13;

      var map = L.map(elMap, {
        zoomControl: true,
        scrollWheelZoom: true,
        minZoom: 11,
        maxZoom: 18
      }).setView([lat, lng], zoom);

      var tileLayer = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        maxZoom: 19,
        crossOrigin: true
      });

      tileLayer.addTo(map);

      var cluster = null;
      var markers = [];
      var clusterReady = false;
      var pendingData = null;

      function showMap(){
        if(elMap){
          elMap.style.opacity = '1';
          inv();
        }
      }

      map.whenReady(function(){
        setTimeout(function(){
          try {
            cluster = L.markerClusterGroup({
              showCoverageOnHover: false,
              maxClusterRadius: 40,
              spiderfyOnMaxZoom: true,
              zoomToBoundsOnClick: true,
              disableClusteringAtZoom: 17,
              spiderfyDistanceMultiplier: 2.5
            });

            map.addLayer(cluster);
            clusterReady = true;

            if(markers.length > 0){
              markers.forEach(function(m){
                try {
                  m.off();
                  if(map.hasLayer(m)) map.removeLayer(m);
                } catch(e) {}
              });
              markers = [];

              if(pendingData && pendingData.length > 0){
                setTimeout(function(){ draw(pendingData); }, 300);
              }
            }
          } catch(e){
            cluster = null;
            clusterReady = false;
          }
        }, 800);
      });

      function inv(){
        try{
          map.invalidateSize(false);
        } catch(_){}
      }

      setTimeout(inv, 80);
      setTimeout(inv, 300);
      setTimeout(inv, 900);
      window.addEventListener('resize', inv);

      var lastSubmitTime = 0;
      var FLOOD_DELAY = 60000;
      var mapMoveDetected = false;
      var mapClickTimeout = null;
      var MIN_ZOOM_FOR_ADD = 17;

      map.on('movestart', function(){
        mapMoveDetected = true;
      });

      map.on('moveend', function(){
        setTimeout(function(){
          mapMoveDetected = false;
        }, 100);
      });

      map.on('click', function(e){
        if(mapMoveDetected) return;

        if(map.getZoom() < MIN_ZOOM_FOR_ADD){
          alert('Przybli≈º mapƒô maksymalnie (zoom ' + MIN_ZOOM_FOR_ADD + '+)!');
          return;
        }

        if(mapClickTimeout) clearTimeout(mapClickTimeout);

        mapClickTimeout = setTimeout(function(){
          if(!CFG.isLoggedIn){
            if(confirm('Musisz byƒá zalogowany. Przej≈õƒá do logowania?')){
              window.location.href = CFG.loginUrl;
            }
            return;
          }

          var now = Date.now();
          if(lastSubmitTime > 0 && (now - lastSubmitTime) < FLOOD_DELAY){
            var sec = Math.ceil((FLOOD_DELAY - (now - lastSubmitTime)) / 1000);
            alert('Poczekaj jeszcze ' + sec + ' sekund.');
            return;
          }

          var lat = e.latlng.lat.toFixed(6);
          var lng = e.latlng.lng.toFixed(6);

          var formHtml = '<header><h3>Dodaj nowe miejsce</h3><button class="jg-close" id="add-close">&times;</button></header>' +
            '<form id="add-form" class="jg-grid cols-2">' +
            '<input type="hidden" name="lat" value="' + lat + '">' +
            '<input type="hidden" name="lng" value="' + lng + '">' +
            '<label>Tytu≈Ç* <input name="title" required placeholder="Nazwa miejsca" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px"></label>' +
            '<label>Typ* <select name="type" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px">' +
            '<option value="zgloszenie">Zg≈Çoszenie</option>' +
            '<option value="ciekawostka">Ciekawostka</option>' +
            '<option value="miejsce">Miejsce</option>' +
            '</select></label>' +
            '<label class="cols-2">Opis <textarea name="content" rows="4" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px"></textarea></label>' +
            '<label class="cols-2"><input type="checkbox" name="public_name"> Poka≈º mojƒÖ nazwƒô u≈ºytkownika</label>' +
            '<label class="cols-2">Zdjƒôcia (max 6) <input type="file" name="images" multiple accept="image/*" style="width:100%;padding:8px"></label>' +
            '<div class="cols-2" style="display:flex;gap:8px;justify-content:flex-end">' +
            '<button type="button" class="jg-btn jg-btn--ghost" id="add-cancel">Anuluj</button>' +
            '<button type="submit" class="jg-btn">Wy≈õlij do moderacji</button>' +
            '</div>' +
            '<div id="add-msg" class="cols-2" style="font-size:12px;color:#555"></div>' +
            '</form>';

          open(modalAdd, formHtml);

          qs('#add-close', modalAdd).onclick = function(){
            close(modalAdd);
          };

          qs('#add-cancel', modalAdd).onclick = function(){
            close(modalAdd);
          };

          var form = qs('#add-form', modalAdd);
          var msg = qs('#add-msg', modalAdd);

          form.onsubmit = function(e){
            e.preventDefault();
            msg.textContent = 'Wysy≈Çanie...';

            var fd = new FormData(form);
            fd.append('action', 'jg_submit_point');
            fd.append('_ajax_nonce', CFG.nonce);

            fetch(CFG.ajax, {
              method: 'POST',
              body: fd,
              credentials: 'same-origin'
            })
            .then(function(r){
              return r.text();
            })
            .then(function(t){
              var j = null;
              try {
                j = JSON.parse(t);
              } catch(_){}

              if(!j || j.success === false){
                throw new Error((j && j.data && j.data.message) || 'B≈ÇƒÖd');
              }

              lastSubmitTime = Date.now();

              msg.textContent = 'Wys≈Çano do moderacji!';
              msg.style.color = '#15803d';
              form.reset();

              setTimeout(function(){
                close(modalAdd);
                refreshData().then(function(){
                  console.log('[JG MAP] Dane od≈õwie≈ºone po dodaniu punktu');
                });
              }, 1500);
            })
            .catch(function(err){
              msg.textContent = err.message || 'B≈ÇƒÖd';
              msg.style.color = '#b91c1c';
            });
          };
        }, 200);
      });

      function iconFor(p){
        var promo = !!p.promo;
        var isPending = !!p.is_pending;
        var isEdit = !!p.is_edit;
        var hasReports = (CFG.isAdmin && p.reports_count > 0);

        var size = promo ? [42, 42] : [28, 28];
        var anchor = [size[0]/2, size[1]/2];
        var c = 'jg-pin';

        if(p.type === 'ciekawostka') c += ' jg-pin--ciekawostka';
        if(p.type === 'miejsce') c += ' jg-pin--miejsce';
        if(p.promo) c += ' jg-pin--promo';
        if(isPending) c += ' jg-pin--pending';
        if(isEdit) c += ' jg-pin--edit';
        if(hasReports) c += ' jg-pin--reported';

        var lbl = (p.type === 'ciekawostka' ? 'i' : (p.type === 'miejsce' ? 'M' : '!'));

        var labelClass = promo ? 'jg-marker-label jg-marker-label--promo' : 'jg-marker-label';
        if(isPending) labelClass += ' jg-marker-label--pending';
        if(isEdit) labelClass += ' jg-marker-label--edit';

        var suffix = '';
        if(isEdit) suffix = ' (edycja)';
        else if(isPending) suffix = ' (oczekuje)';

        var labelHtml = '<span class="' + labelClass + '">' + esc(p.title || 'Bez nazwy') + suffix + '</span>';

        var iconHtml = lbl + labelHtml;

        if(hasReports){
          iconHtml = '<span data-reports="' + p.reports_count + '">' + lbl + '</span>' + labelHtml;
        }

        return L.divIcon({
          className: c,
          html: iconHtml,
          iconSize: size,
          iconAnchor: anchor,
          popupAnchor: [0, -10]
        });
      }

      function api(action, body){
        var fd = new FormData();
        fd.append('action', action);
        fd.append('_ajax_nonce', CFG.nonce || '');
        if(body){
          for(var k in body){
            fd.append(k, body[k]);
          }
        }

        console.log('[JG MAP] API call:', action, 'nonce:', CFG.nonce);

        return fetch(CFG.ajax, {
          method: 'POST',
          body: fd,
          credentials: 'same-origin'
        })
        .then(function(r){
          console.log('[JG MAP] Response status:', r.status);
          return r.text();
        })
        .then(function(t){
          console.log('[JG MAP] Response text:', t.substring(0, 500));
          var j = null;
          try{
            j = JSON.parse(t);
          } catch(e){
            console.error('[JG MAP] JSON parse error:', e);
            console.error('[JG MAP] Raw response:', t);
          }
          if(!j || j.success === false) {
            var errMsg = (j && j.data && (j.data.message || j.data.error)) || 'B≈ÇƒÖd';
            console.error('[JG MAP] API error:', errMsg, j);
            throw new Error(errMsg);
          }
          return j.data;
        });
      }

      var fetchPoints = function(){
        return api('jg_points', {});
      };

      var fetchAuthorPoints = function(a){
        return api('jg_author_points', {author_id: a});
      };

      var reportPoint = function(d){
        return api('jg_report_point', d);
      };

      var getReports = function(id){
        return api('jg_get_reports', {post_id: id});
      };

      var handleReports = function(d){
        return api('jg_handle_reports', d);
      };

      var voteReq = function(d){
        return api('jg_vote', d);
      };

      var updatePoint = function(d){
        return api('jg_update_point', d);
      };

      var adminTogglePromo = function(d){
        return api('jg_admin_toggle_promo', d);
      };

      var adminToggleAuthor = function(d){
        return api('jg_admin_toggle_author', d);
      };

      var adminUpdateNote = function(d){
        return api('jg_admin_update_note', d);
      };

      var adminChangeStatus = function(d){
        return api('jg_admin_change_status', d);
      };

      var adminApprovePoint = function(d){
        return api('jg_admin_approve_point', d);
      };

      var adminRejectPoint = function(d){
        return api('jg_admin_reject_point', d);
      };

      var ALL = [];

      function refreshData(){
        return fetchPoints().then(function(data){
          ALL = (data || []).map(function(r){
            return {
              id: r.id,
              title: r.title || '',
              excerpt: r.excerpt || '',
              content: r.content || '',
              lat: +r.lat,
              lng: +r.lng,
              type: r.type || 'zgloszenie',
              promo: !!r.promo,
              status: r.status || '',
              status_label: r.status_label || '',
              report_status: r.report_status || '',
              report_status_label: r.report_status_label || '',
              author_id: +(r.author_id || 0),
              author_name: (r.author_name || ''),
              author_hidden: !!r.author_hidden,
              images: (r.images || []),
              votes: +(r.votes || 0),
              my_vote: (r.my_vote || ''),
              date: r.date || null,
              admin: r.admin || null,
              admin_note: r.admin_note || '',
              is_pending: !!r.is_pending,
              is_edit: !!r.is_edit,
              edit_info: r.edit_info || null,
              reports_count: +(r.reports_count || 0)
            };
          });
          apply();
          return ALL;
        });
      }

      function draw(list){
        console.log('[JG MAP] draw() wywo≈Çane, punkt√≥w:', list ? list.length : 0);

        if(!list || list.length === 0) {
          showMap();
          return;
        }

        // Stw√≥rz cluster JE≈öLI nie istnieje
        if(!cluster){
          console.log('[JG MAP] Tworzƒô cluster...');
          try {
            cluster = L.markerClusterGroup({
              showCoverageOnHover: false,
              maxClusterRadius: 40,
              spiderfyOnMaxZoom: true,
              zoomToBoundsOnClick: true,
              disableClusteringAtZoom: 17,
              spiderfyDistanceMultiplier: 2.5,
              animate: true,
              animateAddingMarkers: false
            });

            map.addLayer(cluster);
            clusterReady = true;
          } catch(e){
            console.error('[JG MAP] B≈ÇƒÖd tworzenia clustera:', e);
            clusterReady = false;
          }
        } else {
          // Wyczy≈õƒá istniejƒÖcy cluster
          try {
            cluster.clearLayers();
          } catch(e) {}
        }

        // Oblicz bounds dla wszystkich punkt√≥w
        var bounds = [];
        var validPoints = 0;

        list.forEach(function(p){
          if(!p.lat || !p.lng) return;
          var lat = parseFloat(p.lat);
          var lng = parseFloat(p.lng);
          if(isNaN(lat) || isNaN(lng)) return;
          bounds.push([lat, lng]);
          validPoints++;
        });

        if(validPoints === 0) {
          showMap();
          return;
        }

        console.log('[JG MAP] Prawid≈Çowych punkt√≥w:', validPoints);

        // Dodaj markery
        var addedCount = 0;

        list.forEach(function(p){
          if(!p.lat || !p.lng) return;

          try {
            var lat = parseFloat(p.lat);
            var lng = parseFloat(p.lng);

            if(isNaN(lat) || isNaN(lng)) return;

            var m = L.marker([lat, lng], {icon: iconFor(p)});

            (function(point){
              m.on('click', function(e){
                if(e && e.originalEvent) e.originalEvent.stopPropagation();
                L.DomEvent.stopPropagation(e);
                openDetails(point);
              });
            })(p);

            if(clusterReady && cluster){
              cluster.addLayer(m);
            } else {
              m.addTo(map);
              markers.push(m);
            }
            addedCount++;
          } catch(e){
            console.error('[JG MAP] B≈ÇƒÖd dodawania markera:', e);
          }
        });

        console.log('[JG MAP] Dodano marker√≥w:', addedCount);

        // Ustaw widok aby pokazaƒá wszystkie punkty
        if(bounds.length > 0){
          setTimeout(function(){
            try {
              // U≈ºyj L.latLngBounds z tablicƒÖ punkt√≥w
              var leafletBounds = L.latLngBounds(bounds);

              // Dla ma≈Çej liczby punkt√≥w u≈ºyj wy≈ºszego zoomu
              var padding = validPoints <= 3 ? [100, 100] : [50, 50];
              var maxZoom = validPoints === 1 ? 16 : (validPoints <= 3 ? 15 : 14);

              map.fitBounds(leafletBounds, {
                padding: padding,
                maxZoom: maxZoom,
                animate: false
              });

              console.log('[JG MAP] FitBounds wykonany, zoom:', map.getZoom());
            } catch(e){
              console.error('[JG MAP] B≈ÇƒÖd fitBounds:', e);
            }

            showMap();
            hideLoading();
          }, 400);
        } else {
          showMap();
          hideLoading();
        }
      }

      function chip(p){
        var h = '';
        if(p.promo) h += '<span class="jg-promo-tag">P≈ÅATNA PROMOCJA</span>';

        if(p.type === 'zgloszenie' && p.report_status){
          var statusClass = 'jg-status-badge--' + p.report_status;
          h += '<span class="jg-status-badge ' + statusClass + '">' + esc(p.report_status_label || p.report_status) + '</span>';
        }

        return h;
      }

      function colorForVotes(n){
        if(n > 100) return 'color:#b58900;font-weight:800';
        if(n > 0) return 'color:#15803d;font-weight:700';
        if(n < 0) return 'color:#b91c1c;font-weight:700';
        return 'color:#111';
      }

      function openLightbox(src){
        open(lightbox, '<button class="jg-lb-close" id="lb-close">Zamknij</button><img src="' + esc(src) + '" alt="">');
        var b = qs('#lb-close', lightbox);
        if(b) b.onclick = function(){
          close(lightbox);
        };
      }

      function openAuthorModal(authorId, name){
        open(modalAuthor, '<header><h3>Miejsca: ' + esc(name || 'Autor') + '</h3><button class="jg-close" id="ath-close">&times;</button></header><div id="ath-list">≈Åadowanie...</div>');
        qs('#ath-close', modalAuthor).onclick = function(){
          close(modalAuthor);
        };

        fetchAuthorPoints(authorId).then(function(items){
          var holder = qs('#ath-list', modalAuthor);
          if(!items || !items.length){
            holder.innerHTML = '<p>Brak miejsc.</p>';
            return;
          }
          var html = '<ul style="margin:0;padding-left:18px">';
          items.forEach(function(it){
            html += '<li><a href="#" data-id="' + it.id + '" class="jg-author-place">' + esc(it.title || ('Punkt #' + it.id)) + '</a></li>';
          });
          html += '</ul>';
          holder.innerHTML = html;
          holder.querySelectorAll('.jg-author-place').forEach(function(a){
            a.addEventListener('click', function(ev){
              ev.preventDefault();
              var id = +this.getAttribute('data-id');
              var p = ALL.find(function(x){
                return +x.id === id;
              });
              if(p){
                close(modalAuthor);
                openDetails(p);
              }
            });
          });
        }).catch(function(){
          qs('#ath-list', modalAuthor).innerHTML = '<p>B≈ÇƒÖd.</p>';
        });
      }

      function openReportModal(p){
        open(modalReport, '<header><h3>Zg≈Ço≈õ do moderacji</h3><button class="jg-close" id="rpt-close">&times;</button></header><form id="report-form" class="jg-grid"><input type="email" name="email" placeholder="Tw√≥j e-mail (opcjonalnie)" style="padding:8px;border:1px solid #ddd;border-radius:8px"><textarea name="reason" rows="3" placeholder="Pow√≥d (opcjonalnie)" style="padding:8px;border:1px solid #ddd;border-radius:8px"></textarea><div style="display:flex;gap:8px;justify-content:flex-end"><button class="jg-btn" type="submit">Zg≈Ço≈õ</button></div><div id="report-msg" style="font-size:12px;color:#555"></div></form>');
        qs('#rpt-close', modalReport).onclick = function(){
          close(modalReport);
        };

        var f = qs('#report-form', modalReport);
        var msg = qs('#report-msg', modalReport);

        f.onsubmit = function(e){
          e.preventDefault();
          msg.textContent = 'Wysy≈Çanie...';
          reportPoint({
            post_id: p.id,
            email: (f.email.value || ''),
            reason: (f.reason.value || '')
          })
          .then(function(){
            msg.textContent = 'Dziƒôkujemy!';
            f.reset();
            setTimeout(function(){
              close(modalReport);
            }, 900);
          })
          .catch(function(err){
            msg.textContent = (err && err.message) || 'B≈ÇƒÖd';
          });
        };
      }

      function openReportsListModal(p){
        open(modalReportsList, '<header><h3>Zg≈Çoszenia</h3><button class="jg-close" id="rplist-close">&times;</button></header><div id="reports-content">≈Åadowanie...</div>');
        qs('#rplist-close', modalReportsList).onclick = function(){
          close(modalReportsList);
        };

        getReports(p.id).then(function(data){
          var holder = qs('#reports-content', modalReportsList);
          if(!data.reports || data.reports.length === 0){
            holder.innerHTML = '<p>Brak zg≈Çosze≈Ñ.</p>';
            return;
          }

          var html = '<div class="jg-reports-warning">' +
            '<div class="jg-reports-warning-title">‚ö†Ô∏è Zg≈Çosze≈Ñ: ' + data.count + '</div>';

          data.reports.forEach(function(r){
            html += '<div class="jg-report-item">' +
              '<div class="jg-report-item-header">' +
              '<span class="jg-report-item-user">' + esc(r.user_name) + '</span>' +
              '<span class="jg-report-item-date">' + esc(r.date) + '</span>' +
              '</div>' +
              '<div class="jg-report-item-reason">' + esc(r.reason) + '</div>' +
              '</div>';
          });

          html += '</div>' +
            '<div style="margin-top:16px;background:#f8fafc;padding:12px;border-radius:8px">' +
            '<strong>Decyzja:</strong>' +
            '<div style="margin-top:12px">' +
            '<label style="display:block;margin-bottom:8px">Uzasadnienie (opcjonalne):<br>' +
            '<textarea id="admin-reason" rows="3" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;margin-top:4px"></textarea>' +
            '</label>' +
            '<div style="display:flex;gap:8px;justify-content:flex-end">' +
            '<button class="jg-btn jg-btn--ghost" id="btn-keep">Pozostaw</button>' +
            '<button class="jg-btn jg-btn--danger" id="btn-remove">Usu≈Ñ</button>' +
            '</div>' +
            '<div id="handle-msg" style="margin-top:8px;font-size:12px"></div>' +
            '</div>' +
            '</div>';

          holder.innerHTML = html;

          var reasonField = qs('#admin-reason', modalReportsList);
          var handleMsg = qs('#handle-msg', modalReportsList);

          qs('#btn-keep', modalReportsList).onclick = function(){
            if(!confirm('Pozostawiƒá miejsce? Zg≈Çoszenia zostanƒÖ usuniƒôte.')) return;

            this.disabled = true;
            handleMsg.textContent = 'Przetwarzanie...';

            handleReports({
              post_id: p.id,
              action_type: 'keep',
              reason: reasonField.value
            })
            .then(function(result){
              handleMsg.textContent = result.message;
              handleMsg.style.color = '#15803d';
              setTimeout(function(){
                close(modalReportsList);
                refreshData();
              }, 1500);
            })
            .catch(function(err){
              handleMsg.textContent = err.message || 'B≈ÇƒÖd';
              handleMsg.style.color = '#b91c1c';
              this.disabled = false;
            }.bind(this));
          };

          qs('#btn-remove', modalReportsList).onclick = function(){
            if(!confirm('UsunƒÖƒá miejsce?')) return;

            this.disabled = true;
            handleMsg.textContent = 'Przetwarzanie...';

            handleReports({
              post_id: p.id,
              action_type: 'remove',
              reason: reasonField.value
            })
            .then(function(result){
              handleMsg.textContent = result.message;
              handleMsg.style.color = '#15803d';
              setTimeout(function(){
                close(modalReportsList);
                close(modalView);
                refreshData();
              }, 1500);
            })
            .catch(function(err){
              handleMsg.textContent = err.message || 'B≈ÇƒÖd';
              handleMsg.style.color = '#b91c1c';
              this.disabled = false;
            }.bind(this));
          };

        }).catch(function(){
          qs('#reports-content', modalReportsList).innerHTML = '<p style="color:#b91c1c">B≈ÇƒÖd.</p>';
        });
      }

      function openEditModal(p){
        var contentText = p.content ? p.content.replace(/<\/?[^>]+(>|$)/g, "") : (p.excerpt || '');
        open(modalEdit, '<header><h3>Edytuj</h3><button class="jg-close" id="edt-close">&times;</button></header><form id="edit-form" class="jg-grid cols-2"><label>Tytu≈Ç* <input name="title" required value="' + esc(p.title || '') + '" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px"></label><label>Typ* <select name="type" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px"><option value="zgloszenie"' + (p.type === 'zgloszenie' ? ' selected' : '') + '>Zg≈Çoszenie</option><option value="ciekawostka"' + (p.type === 'ciekawostka' ? ' selected' : '') + '>Ciekawostka</option><option value="miejsce"' + (p.type === 'miejsce' ? ' selected' : '') + '>Miejsce</option></select></label><label class="cols-2">Opis <textarea name="content" rows="6" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px">' + contentText + '</textarea></label><div class="cols-2" style="display:flex;gap:8px;justify-content:flex-end"><button type="button" class="jg-btn jg-btn--ghost" id="edt-cancel">Anuluj</button><button type="submit" class="jg-btn">Zapisz</button></div><div id="edit-msg" class="cols-2" style="font-size:12px"></div></form>');

        qs('#edt-close', modalEdit).onclick = function(){
          close(modalEdit);
        };

        qs('#edt-cancel', modalEdit).onclick = function(){
          close(modalEdit);
        };

        var form = qs('#edit-form', modalEdit);
        var msg = qs('#edit-msg', modalEdit);

        form.onsubmit = function(e){
          e.preventDefault();
          msg.textContent = 'Zapisywanie...';
          var fd = {
            post_id: p.id,
            title: form.title.value.trim(),
            type: form.type.value,
            content: form.content.value
          };
          if(!fd.title){
            form.title.focus();
            msg.textContent = 'Podaj tytu≈Ç.';
            msg.style.color = '#b91c1c';
            return;
          }
          updatePoint(fd).then(function(){
            msg.textContent = 'Zaktualizowano.';
            setTimeout(function(){
              close(modalEdit);
              refreshData().then(function(){
                alert('Wys≈Çano do moderacji. Zmiany bƒôdƒÖ widoczne po zaakceptowaniu.');
              });
            }, 300);
          }).catch(function(err){
            msg.textContent = (err && err.message) || 'B≈ÇƒÖd';
            msg.style.color = '#b91c1c';
          });
        };
      }

      function openStatusModal(p){
        var currentStatus = p.report_status || 'added';
        var html = '<header><h3>Zmie≈Ñ status</h3><button class="jg-close" id="status-close">&times;</button></header>' +
          '<div class="jg-grid" style="padding:16px">' +
          '<p>Wybierz status:</p>' +
          '<div style="display:flex;flex-direction:column;gap:12px;margin:16px 0">' +
          '<label style="display:flex;align-items:center;gap:8px;padding:12px;border:2px solid #e5e7eb;border-radius:8px;cursor:pointer">' +
          '<input type="radio" name="status" value="added" ' + (currentStatus === 'added' ? 'checked' : '') + ' style="width:20px;height:20px">' +
          '<div><strong>Dodane</strong></div>' +
          '</label>' +
          '<label style="display:flex;align-items:center;gap:8px;padding:12px;border:2px solid #e5e7eb;border-radius:8px;cursor:pointer">' +
          '<input type="radio" name="status" value="reported" ' + (currentStatus === 'reported' ? 'checked' : '') + ' style="width:20px;height:20px">' +
          '<div><strong>Zg≈Çoszone do instytucji</strong></div>' +
          '</label>' +
          '<label style="display:flex;align-items:center;gap:8px;padding:12px;border:2px solid #e5e7eb;border-radius:8px;cursor:pointer">' +
          '<input type="radio" name="status" value="resolved" ' + (currentStatus === 'resolved' ? 'checked' : '') + ' style="width:20px;height:20px">' +
          '<div><strong>RozwiƒÖzane</strong></div>' +
          '</label>' +
          '</div>' +
          '<div style="display:flex;gap:8px;justify-content:flex-end">' +
          '<button type="button" class="jg-btn jg-btn--ghost" id="status-cancel">Anuluj</button>' +
          '<button type="button" class="jg-btn" id="status-save">Zapisz</button>' +
          '</div>' +
          '<div id="status-msg" style="margin-top:12px;font-size:12px"></div>' +
          '</div>';

        open(modalStatus, html);

        qs('#status-close', modalStatus).onclick = function(){
          close(modalStatus);
        };

        qs('#status-cancel', modalStatus).onclick = function(){
          close(modalStatus);
        };

        var msg = qs('#status-msg', modalStatus);
        var saveBtn = qs('#status-save', modalStatus);

        saveBtn.onclick = function(){
          var selected = qs('input[name="status"]:checked', modalStatus);
          if(!selected){
            msg.textContent = 'Wybierz status';
            msg.style.color = '#b91c1c';
            return;
          }

          var newStatus = selected.value;
          if(newStatus === currentStatus){
            close(modalStatus);
            return;
          }

          msg.textContent = 'Zapisywanie...';
          saveBtn.disabled = true;

          adminChangeStatus({post_id: p.id, new_status: newStatus})
            .then(function(result){
              p.report_status = result.report_status;
              p.report_status_label = result.report_status_label;
              msg.textContent = 'Zmieniono!';
              msg.style.color = '#15803d';
              setTimeout(function(){
                close(modalStatus);
                close(modalView);
                refreshData();
              }, 1000);
            })
            .catch(function(err){
              msg.textContent = 'B≈ÇƒÖd: ' + (err.message || '?');
              msg.style.color = '#b91c1c';
              saveBtn.disabled = false;
            });
        };
      }

      function openDetails(p){
        var imgs = Array.isArray(p.images) ? p.images : [];
        var gal = imgs.map(function(u){
          return '<img src="' + esc(u) + '" alt="">';
        }).join('');

        var dateInfo = (p.date && p.date.human) ? '<div class="jg-date-info">Dodano: ' + esc(p.date.human) + '</div>' : '';

        var who = '';
        if(p.author_name && p.author_name.trim() !== ''){
          who = '<div><strong>Autor:</strong> <a href="#" id="btn-author" data-id="' + esc(p.author_id) + '">' + esc(p.author_name) + '</a></div>';
        } else if(p.author_hidden || p.author_id > 0){
          who = '<div><strong>Autor:</strong> ukryty</div>';
        }

        var adminNote = '';
        if(p.admin_note && p.admin_note.trim()){
          adminNote = '<div class="jg-admin-note"><div class="jg-admin-note-title">üì¢ Notatka administratora</div><div class="jg-admin-note-content">' + esc(p.admin_note) + '</div></div>';
        }

        var editInfo = '';
        if(CFG.isAdmin && p.is_edit && p.edit_info){
          var changes = [];
          if(p.edit_info.prev_title && p.edit_info.prev_title !== p.title){
            changes.push('<div><strong>Tytu≈Ç:</strong><br><span style="text-decoration:line-through;color:#dc2626">' + esc(p.edit_info.prev_title) + '</span><br><span style="color:#16a34a">‚Üí ' + esc(p.title) + '</span></div>');
          }
          if(p.edit_info.prev_type && p.edit_info.prev_type !== p.type){
            var typeLabels = {zgloszenie:'Zg≈Çoszenie',ciekawostka:'Ciekawostka',miejsce:'Miejsce'};
            changes.push('<div><strong>Typ:</strong><br><span style="text-decoration:line-through;color:#dc2626">' + (typeLabels[p.edit_info.prev_type]||p.edit_info.prev_type) + '</span><br><span style="color:#16a34a">‚Üí ' + (typeLabels[p.type]||p.type) + '</span></div>');
          }
          if(p.edit_info.prev_content && p.edit_info.prev_content !== p.content){
            var prevContentText = p.edit_info.prev_content.replace(/<\/?[^>]+(>|$)/g, '');
            var newContentText = p.content ? p.content.replace(/<\/?[^>]+(>|$)/g, '') : '';
            changes.push('<div><strong>Opis:</strong><br>' +
              '<div style="max-height:150px;overflow-y:auto;padding:8px;background:#fee;border-radius:4px;margin-top:4px">' +
              '<strong style="color:#dc2626">Poprzedni:</strong><br>' +
              (prevContentText ? esc(prevContentText) : '<em>brak</em>') +
              '</div>' +
              '<div style="max-height:150px;overflow-y:auto;padding:8px;background:#d1fae5;border-radius:4px;margin-top:8px">' +
              '<strong style="color:#16a34a">Nowy:</strong><br>' +
              (newContentText ? esc(newContentText) : '<em>brak</em>') +
              '</div>' +
              '</div>');
          }

          if(changes.length > 0){
            editInfo = '<div style="background:#faf5ff;border:2px solid #9333ea;border-radius:8px;padding:12px;margin:16px 0"><div style="font-weight:700;margin-bottom:8px;color:#6b21a8">üìù Zmiany oczekujƒÖce:</div>' + changes.join('') + '</div>';
          }
        }

        var reportsWarning = '';
        if(CFG.isAdmin && p.reports_count > 0){
          reportsWarning = '<div class="jg-reports-warning">' +
            '<div class="jg-reports-warning-title">‚ö†Ô∏è Zg≈Çosze≈Ñ: ' + p.reports_count + '</div>' +
            '<button class="jg-btn" id="btn-view-reports" style="margin-top:8px">Zobacz zg≈Çoszenia</button>' +
            '</div>';
        }

        var adminBox = '';
        if(CFG.isAdmin){
          var adminData = [];
          if(p.admin){
            adminData.push('<div><strong>Autor:</strong> ' + esc(p.admin.author_name_real || '?') + '</div>');
            adminData.push('<div><strong>Email:</strong> ' + esc(p.admin.author_email || '?') + '</div>');
            if(p.admin.ip && p.admin.ip !== '(brak)' && p.admin.ip.trim() !== ''){
              adminData.push('<div><strong>IP:</strong> ' + esc(p.admin.ip) + '</div>');
            }
          }

          adminData.push('<div><strong>Status:</strong> ' + esc(p.status) + '</div>');

          var controls = '<div class="jg-admin-controls">';

          if(p.is_pending){
            controls += '<button class="jg-btn" id="btn-approve-point" style="background:#15803d">‚úì Akceptuj</button>';
            controls += '<button class="jg-btn" id="btn-reject-point" style="background:#b91c1c">‚úó Odrzuƒá</button>';
          }

          controls += '<button class="jg-btn jg-btn--ghost" id="btn-toggle-promo">' + (p.promo ? 'Usu≈Ñ promocjƒô' : 'Promocja') + '</button>';
          controls += '<button class="jg-btn jg-btn--ghost" id="btn-toggle-author">' + (p.author_hidden ? 'Ujawnij' : 'Ukryj') + ' autora</button>';
          if(p.type === 'zgloszenie'){
            controls += '<button class="jg-btn jg-btn--ghost" id="btn-change-status">Zmie≈Ñ status</button>';
          }
          controls += '<button class="jg-btn jg-btn--ghost" id="btn-admin-note">' + (p.admin_note ? 'Edytuj' : 'Dodaj') + ' notatkƒô</button>';
          controls += '</div>';

          adminBox = '<div class="jg-admin-panel"><div class="jg-admin-panel-title">Panel Administratora</div>' + adminData.join('') + controls + '</div>';
        }

        var promoClass = p.promo ? ' jg-modal--promo' : '';
        var typeClass = ' jg-modal--' + (p.type || 'zgloszenie');
        var canEdit = (CFG.isAdmin || (CFG.currentUserId > 0 && CFG.currentUserId === +p.author_id));
        var myVote = p.my_vote || '';

        var html = '<header><h3>' + esc(p.title || 'Szczeg√≥≈Çy') + '</h3><button class="jg-close" id="dlg-close">&times;</button></header><div class="jg-grid" style="overflow:auto">' + dateInfo + '<div style="margin-bottom:10px">' + chip(p) + '</div>' + reportsWarning + editInfo + adminNote + (p.content ? ('<div>' + p.content + '</div>') : (p.excerpt ? ('<p>' + esc(p.excerpt) + '</p>') : '')) + (gal ? ('<div class="jg-gallery" style="margin-top:10px">' + gal + '</div>') : '') + (who ? ('<div style="margin-top:10px">' + who + '</div>') : '') + '<div class="jg-vote"><button id="v-up" ' + (myVote === 'up' ? 'class="active"' : '') + '>‚¨ÜÔ∏è</button><span class="cnt" id="v-cnt" style="' + colorForVotes(+p.votes || 0) + '">' + (p.votes || 0) + '</span><button id="v-down" ' + (myVote === 'down' ? 'class="active"' : '') + '>‚¨áÔ∏è</button></div>' + adminBox + '<div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">' + (canEdit ? '<button id="btn-edit" class="jg-btn jg-btn--ghost">Edytuj</button>' : '') + '<button id="btn-report" class="jg-btn jg-btn--ghost">Zg≈Ço≈õ</button></div></div>';

        open(modalView, html, {addClass: (promoClass + typeClass).trim()});

        qs('#dlg-close', modalView).onclick = function(){
          close(modalView);
        };

        var g = qs('.jg-gallery', modalView);
        if(g){
          g.querySelectorAll('img').forEach(function(img){
            img.addEventListener('click', function(){
              openLightbox(this.src);
            });
          });
        }

        var cnt = qs('#v-cnt', modalView);
        var up = qs('#v-up', modalView);
        var down = qs('#v-down', modalView);

        function refresh(n, my){
          cnt.textContent = n;
          cnt.setAttribute('style', colorForVotes(+n || 0));
          up.classList.toggle('active', my === 'up');
          down.classList.toggle('active', my === 'down');
        }

        function doVote(dir){
          if(!CFG.isLoggedIn) {
            alert('Zaloguj siƒô.');
            return;
          }
          up.disabled = down.disabled = true;
          voteReq({post_id: p.id, dir: dir})
            .then(function(d){
              p.votes = +d.votes || 0;
              p.my_vote = d.my_vote || '';
              refresh(p.votes, p.my_vote);
            })
            .catch(function(e){
              alert((e && e.message) || 'B≈ÇƒÖd');
            })
            .finally(function(){
              up.disabled = down.disabled = false;
            });
        }

        up.onclick = function(){
          doVote('up');
        };

        down.onclick = function(){
          doVote('down');
        };

        qs('#btn-report', modalView).onclick = function(){
          openReportModal(p);
        };

        if(canEdit){
          var editBtn = qs('#btn-edit', modalView);
          if(editBtn) editBtn.onclick = function(){
            openEditModal(p);
          };
        }

        var ba = qs('#btn-author', modalView);
        if(ba){
          ba.addEventListener('click', function(ev){
            ev.preventDefault();
            openAuthorModal(+this.getAttribute('data-id'), this.textContent);
          });
        }

        if(CFG.isAdmin){
          var btnViewReports = qs('#btn-view-reports', modalView);
          if(btnViewReports){
            btnViewReports.onclick = function(){
              openReportsListModal(p);
            };
          }

          var btnPromo = qs('#btn-toggle-promo', modalView);
          var btnAuthor = qs('#btn-toggle-author', modalView);
          var btnStatus = qs('#btn-change-status', modalView);
          var btnNote = qs('#btn-admin-note', modalView);
          var btnApprove = qs('#btn-approve-point', modalView);
          var btnReject = qs('#btn-reject-point', modalView);

          if(btnApprove){
            btnApprove.onclick = function(){
              if(!confirm('Zaakceptowaƒá?')) return;
              btnApprove.disabled = true;
              btnApprove.textContent = 'Akceptowanie...';

              adminApprovePoint({post_id: p.id})
                .then(function(){
                  close(modalView);
                  return refreshData();
                })
                .then(function(){
                  alert('Zaakceptowano i opublikowano!');
                })
                .catch(function(err){
                  alert('B≈ÇƒÖd: ' + (err.message || '?'));
                  btnApprove.disabled = false;
                  btnApprove.textContent = '‚úì Akceptuj';
                });
            };
          }

          if(btnReject){
            btnReject.onclick = function(){
              var reason = prompt('Pow√≥d odrzucenia (zostanie wys≈Çany do autora):');
              if(reason === null) return;

              btnReject.disabled = true;
              btnReject.textContent = 'Odrzucanie...';

              adminRejectPoint({post_id: p.id, reason: reason})
                .then(function(){
                  close(modalView);
                  return refreshData();
                })
                .then(function(){
                  alert('Odrzucono i przeniesiono do kosza.');
                })
                .catch(function(err){
                  alert('B≈ÇƒÖd: ' + (err.message || '?'));
                  btnReject.disabled = false;
                  btnReject.textContent = '‚úó Odrzuƒá';
                });
            };
          }

          if(btnPromo){
            btnPromo.onclick = function(){
              if(!confirm((p.promo ? 'UsunƒÖƒá' : 'Dodaƒá') + ' promocjƒô?')) return;
              btnPromo.disabled = true;

              adminTogglePromo({post_id: p.id})
                .then(function(result){
                  p.promo = result.promo;
                  close(modalView);
                  return refreshData();
                })
                .then(function(){
                  alert('Zaktualizowano!');
                })
                .catch(function(err){
                  alert('B≈ÇƒÖd: ' + (err.message || '?'));
                  btnPromo.disabled = false;
                });
            };
          }

          if(btnAuthor){
            btnAuthor.onclick = function(){
              if(!confirm((p.author_hidden ? 'Ujawniƒá' : 'Ukryƒá') + ' autora?')) return;
              btnAuthor.disabled = true;

              adminToggleAuthor({post_id: p.id})
                .then(function(result){
                  p.author_hidden = result.author_hidden;
                  alert('Zaktualizowano!');
                  close(modalView);
                  setTimeout(function(){
                    window.location.reload();
                  }, 500);
                })
                .catch(function(err){
                  alert('B≈ÇƒÖd: ' + (err.message || '?'));
                  btnAuthor.disabled = false;
                });
            };
          }

          if(btnStatus){
            btnStatus.onclick = function(){
              openStatusModal(p);
            };
          }

          if(btnNote){
            btnNote.onclick = function(){
              var currentNote = p.admin_note || '';
              var newNote = prompt('Notatka administratora:', currentNote);
              if(newNote === null) return;

              btnNote.disabled = true;

              adminUpdateNote({post_id: p.id, note: newNote})
                .then(function(result){
                  p.admin_note = newNote;
                  close(modalView);
                  return refreshData();
                })
                .then(function(){
                  alert('Zaktualizowano!');
                })
                .catch(function(err){
                  alert('B≈ÇƒÖd: ' + (err.message || '?'));
                  btnNote.disabled = false;
                });
            };
          }
        }
      }

      function apply(){
        var enabled = {};
        var promoOnly = false;
        var searchQuery = '';

        if(elFilters){
          elFilters.querySelectorAll('input[data-type]').forEach(function(cb){
            if(cb.checked) enabled[cb.getAttribute('data-type')] = true;
          });
          var pr = elFilters.querySelector('input[data-promo]');
          promoOnly = !!(pr && pr.checked);

          var searchInput = document.getElementById('jg-search-input');
          if(searchInput){
            searchQuery = searchInput.value.toLowerCase().trim();
          }
        }

        var list = (ALL || []).filter(function(p){
          if(searchQuery){
            var title = (p.title || '').toLowerCase();
            if(title.indexOf(searchQuery) === -1) return false;
          }

          if(promoOnly) return p.promo;
          if(p.promo) return true;

          var passType = (Object.keys(enabled).length ? !!enabled[p.type] : true);
          return passType;
        });

        pendingData = list;
        draw(list);
      }

      setTimeout(function(){
        var searchInput = document.getElementById('jg-search-input');
        if(searchInput){
          searchInput.addEventListener('input', function(){
            apply();
          });
        }
      }, 100);

      fetchPoints()
        .then(function(data){
          ALL = (data || []).map(function(r){
            return {
              id: r.id,
              title: r.title || '',
              excerpt: r.excerpt || '',
              content: r.content || '',
              lat: +r.lat,
              lng: +r.lng,
              type: r.type || 'zgloszenie',
              promo: !!r.promo,
              status: r.status || '',
              status_label: r.status_label || '',
              report_status: r.report_status || '',
              report_status_label: r.report_status_label || '',
              author_id: +(r.author_id || 0),
              author_name: (r.author_name || ''),
              author_hidden: !!r.author_hidden,
              images: (r.images || []),
              votes: +(r.votes || 0),
              my_vote: (r.my_vote || ''),
              date: r.date || null,
              admin: r.admin || null,
              admin_note: r.admin_note || '',
              is_pending: !!r.is_pending,
              is_edit: !!r.is_edit,
              edit_info: r.edit_info || null,
              reports_count: +(r.reports_count || 0)
            };
          });

          apply();

          if(elFilters){
            elFilters.querySelectorAll('input').forEach(function(inp){
              inp.addEventListener('change', apply);
            });
          }
        })
        .catch(function(e){
          showError('Nie uda≈Ço siƒô pobraƒá punkt√≥w: ' + (e.message || '?'));
        });

    } catch(e) {
      showError('B≈ÇƒÖd: ' + e.message);
    }
  }
})();
</script>
